<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-ajax/core-ajax.html">

<polymer-element name="nn-annotable" attributes="nid baseapi">
  <template>

    <core-ajax
      id="get_comments"
      url="{{baseapi}}/{{domain}}/{{nid}}/comments"
      handleAs="json"
      on-core-response="{{populateComments}}">
    </core-ajax>

    <core-ajax
      id="new_comment"
      url="{{baseapi}}/{{domain}}/{{nid}}/comments"
      handleAs="json"
      method="post"
      params='{"author":"{{author}}","text":"{{text}}"}'
      on-core-response="{{resetForm}}">
    </core-ajax>

    <content></content>

    <section>
      <h3>New Annotation</h3>
      <form id="new_comment_form" on-submit="{{newComment}}">
        <input type="text" value="{{author}}">
        <textarea value="{{text}}"></textarea>
        <input type="submit">
      </form>
    </section>
    <section>
      <template bind if="{{comments.length > 0}}">
        <template repeat="{{comment, i in comments}}">
          <dl>
            <dt>{{comment.author}}</dt>
            <dd>{{comment.text}}</dd>
          </dl>
        </template>
      </template>
    </section>

  </template>
  <script>
    Polymer({
      attached: function() {
        // In Polymer all attributes are properties of "this".
        if (!this.nid) {
          throw 'Attribute missing: nid';
        }
        this.$.get_comments.go();
      },
      ready: function() {
        this.domain = window.location.hostname;
        this.baseapi = this.baseapi || window.location.origin;
        this.comments = [];
      },
      populateComments: function(evt) {
        this.comments = evt.detail.response;
      },
      newComment: function(evt) {
        this.message = "";
        evt.preventDefault();
        if (!this.author || !this.text) {
          this.message = "completa tutti i campi";
          return;
        }
        this.$.new_comment.go();
      },
      resetForm: function() {
        this.author = "";
        this.text = "";
      }
    });
  </script>
</polymer-element>
